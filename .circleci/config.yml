version: 2.1

workflows:
  WebServerDeployment:
      jobs:
        - packer validate
        - terraform validate
        - packer build:
            requires:
              - packer validate
        - terraform plan, apply and test:
            requires:
              - terraform validate
              - packer build
            filters:
              branches:
                only: main

jobs:
  packer validate:
    docker:
      - image: hashicorp/packer
    steps:
      - checkout
      - run:
          name: install ansible
          command: |
            apk add ansible
      - run:
          name: packer validate
          command: |
            cd build-image
            packer validate image_build.json

  terraform validate:
    docker:
      - image: hashicorp/terraform
    steps:
      - checkout
      - run:
          name: terraform validate
          command: |
            terraform init
            terraform validate

  packer build:
    docker:
      - image: hashicorp/packer
    steps:
      - checkout
      - run:
          name: install ansible
          command: |
            apk add ansible
      - run:
          name: packer build
          command: |
            cd build-image
            packer build image_build.json

  terraform plan, apply and test:
    docker:
      - image: hashicorp/terraform
    steps:
      - checkout
      - run:
          name: terraform plan and apply
          command: |
            terraform init
            terraform plan
            terraform apply -auto-approve
      - run:
          name: test server output
          command: |
            url=terraform output -raw elb_dns_name
            curl "$url" | grep "Emmanuel Pius-Ogiji"
